#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üèóÔ∏è Enterprise-Grade Quality Gates - Pre-Commit Validation"
echo "=================================================="

# Track timing for performance monitoring
start_time=$(date +%s)

# 1. Security Layer: Credential scanning with GitLeaks
echo "üîí [1/8] Security: Scanning for credentials and secrets..."

# Ensure GitLeaks is installed before scanning
if ! command -v gitleaks &> /dev/null; then
  echo "üîß GitLeaks not found, installing via enterprise script..."
  if [[ -f "scripts/install-gitleaks.sh" ]]; then
    if ! bash scripts/install-gitleaks.sh; then
      echo "‚ùå Failed to install GitLeaks. Please run 'bash scripts/install-gitleaks.sh' manually."
      exit 1
    fi
  else
    echo "‚ùå GitLeaks installation script not found. Please ensure scripts/install-gitleaks.sh exists."
    exit 1
  fi
fi

# Run GitLeaks security scan
if ! gitleaks detect --source=. --verbose --no-banner --no-git; then
  echo "‚ùå GitLeaks found potential credentials. Please review and fix."
  exit 1
fi

# 2. File Hygiene: Check for large files (1MB limit)
echo "üìè [2/8] File Hygiene: Checking for large files..."
for file in $(git diff --cached --name-only); do
  if [ -f "$file" ]; then
    size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo 0)
    if [ "$size" -gt 1048576 ]; then
      echo "‚ùå File $file is larger than 1MB ($size bytes). Consider using Git LFS."
      exit 1
    fi
  fi
done

# 3. File Hygiene: Check for merge conflict markers
echo "‚öîÔ∏è [3/8] File Hygiene: Checking for merge conflicts..."
if git diff --cached --name-only | xargs grep -l "^<<<<<<< \|^======= \|^>>>>>>> " 2>/dev/null; then
  echo "‚ùå Merge conflict markers found. Please resolve conflicts."
  exit 1
fi

# 4. Code Quality: Run lint-staged (ESLint + Prettier)
echo "üé® [4/8] Code Quality: Running linting and formatting..."
if ! npx lint-staged; then
  echo "‚ùå Linting failed. Please fix issues."
  exit 1
fi

# 5. Type Safety: TypeScript type checking
echo "üî∑ [5/8] Type Safety: Running TypeScript validation..."
if ! pnpm type-check; then
  echo "‚ùå TypeScript type checking failed. Please fix type errors."
  exit 1
fi

# 6. Test Suite: Run all tests for code confidence
echo "üß™ [6/8] Test Suite: Running comprehensive test validation..."
if ! pnpm test; then
  echo "‚ùå Tests failed. Please fix failing tests before committing."
  exit 1
fi

# 7. Security Audit: Check for known vulnerabilities
echo "üõ°Ô∏è [7/8] Security Audit: Checking dependencies for vulnerabilities..."
if ! pnpm ai:security; then
  echo "‚ùå Security audit found vulnerabilities. Please review and fix."
  exit 1
fi

# 8. File Validation: YAML syntax (JSON handled by ESLint)
echo "üìã [8/9] File Validation: Validating YAML files..."
for file in $(git diff --cached --name-only | grep -E '\.(ya?ml)$'); do
  if [ -f "$file" ]; then
    if ! npx js-yaml "$file" >/dev/null 2>&1; then
      echo "‚ùå Invalid YAML file: $file"
      exit 1
    fi
  fi
done

# 9. GitHub Actions Validation: Workflow syntax checking
echo "üöÄ [9/9] GitHub Actions: Validating workflow syntax..."
workflow_files=$(git diff --cached --name-only | grep -E '^\.github/workflows/.*\.ya?ml$' || true)
if [ -n "$workflow_files" ]; then
  if command -v actionlint &> /dev/null; then
    if ! actionlint $workflow_files; then
      echo "‚ùå GitHub Actions workflow validation failed. Please fix workflow syntax."
      exit 1
    fi
    echo "‚úÖ GitHub Actions workflows validated successfully"
  else
    echo "‚ö†Ô∏è actionlint not found. Install with 'brew install actionlint' for workflow validation."
  fi
fi

# Performance monitoring
end_time=$(date +%s)
duration=$((end_time - start_time))

echo "=================================================="
echo "‚úÖ All enterprise-grade quality gates passed!"
echo "üöÄ Total validation time: ${duration}s"
echo "üíØ Code is ready for production deployment"